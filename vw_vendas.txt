SELECT 
	ven.ID,
	empresa.NOME_FANTASIA 'EMPRESA',
	ven.VENDA_NUMERO,
	ven.DATA_VENDA,
	ven.ID_CLIENTE,
	cli.NOME 'CLIENTE',
	cli.CIDADE 'CIDADE',
	cli.BAIRRO 'BAIRRO',
	ven.id_vendedor,
	vendedor.NOME 'VENDEDOR',
    	ven.VALOR_TOTAL 'VALOR_TOTAL',
	ven.VALOR_FRETE 'FRETE',
	ven.VALOR_ACRESCIMO 'ACRESCIMO',
	ven.VALOR_DESCONTO 'DESCONTO',
	formasPagamento.Tipos_Pagamento 'FORMA_PAGAMENTO',
	ven.ID_TABELA_PRECO,
	ven.SITUACAO,
	ven.DEVOLUCAO,
	sum(itens.VALOR_CUSTO) 'CUSTO_VENDA',
	((ven.VALOR_TOTAL-sum(itens.VALOR_CUSTO))/ven.VALOR_TOTAL)*100 'MARGEM'
	
FROM venda_cabecalho ven
INNER JOIN empresa on empresa.id=ven.ID_EMPRESA
INNER JOIN view_pessoa_cliente cli ON cli.ID=ven.id_cliente 
INNER JOIN colaborador colab ON colab.ID=ven.ID_VENDEDOR 
INNER JOIN pessoa vendedor ON colab.ID_PESSOA=vendedor.id AND vendedor.ID_EMPRESA=VEN.ID_EMPRESA
INNER JOIN venda_detalhe itens on itens.ID_VENDA_CABECALHO=ven.id
LEFT JOIN (
	SELECT 
		formapg.ID_VENDA_CABECALHO,
		GROUP_CONCAT(tipopg.DESCRICAO SEPARATOR ', ') AS Tipos_Pagamento
		FROM 
			venda_recebimento formapg
		INNER JOIN 
			fin_tipo_recebimento tipopg ON tipopg.id = formapg.ID_FIN_TIPO_RECEBIMENTO
		GROUP BY 
			formapg.ID_VENDA_CABECALHO
	) formasPagamento on formasPagamento.ID_VENDA_CABECALHO=ven.ID

WHERE 
	ven.SITUACAO <> 'C'

GROUP by
	ven.ID,
	empresa.NOME_FANTASIA,
	ven.VENDA_NUMERO,
	ven.DATA_VENDA,
	ven.ID_CLIENTE,
	cli.NOME,
	ven.id_vendedor,
	vendedor.NOME,
    ven.VALOR_TOTAL,
	ven.VALOR_FRETE,
	ven.VALOR_ACRESCIMO,
	ven.VALOR_DESCONTO,
	ven.FORMA_PAGAMENTO,
	ven.ID_TABELA_PRECO,
	ven.SITUACAO,
	ven.DEVOLUCAO

ORDER BY 
	ven.venda_numero;
